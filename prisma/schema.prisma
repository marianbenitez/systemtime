generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id          String       @id @default(cuid())
  email       String       @unique
  name        String
  password    String
  role        Role         @default(USER)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  attendances Attendance[]

  @@index([email])
  @@map("users")
}

model Attendance {
  id        String           @id @default(cuid())
  userId    String
  date      DateTime
  status    AttendanceStatus
  checkIn   DateTime?
  checkOut  DateTime?
  notes     String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([date])
  @@map("attendances")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Empleado {
  id             Int                @id @default(autoincrement())
  numeroAC       String             @unique @map("numero_ac") @db.VarChar(20)
  numeroId       String?            @map("numero_id") @db.VarChar(10)
  nombre         String             @db.VarChar(150)
  apellido       String             @db.VarChar(150)
  departamento   String?            @db.VarChar(100)
  activo         Boolean            @default(true)
  createdAt      DateTime           @default(now()) @map("created_at")
  updatedAt      DateTime           @updatedAt @map("updated_at")
  asistencias    AsistenciaDiaria[]
  informes       Informe[]
  resumenMensual ResumenMensual[]

  @@index([numeroAC])
  @@map("empleados")
}

model Importacion {
  id                 Int            @id @default(autoincrement())
  nombreArchivo      String         @map("nombre_archivo") @db.VarChar(255)
  tipoArchivo        TipoArchivo    @map("tipo_archivo")
  fechaInicio        DateTime       @map("fecha_inicio") @db.Date
  fechaFin           DateTime       @map("fecha_fin") @db.Date
  totalRegistros     Int            @map("total_registros")
  registrosValidos   Int            @map("registros_validos")
  registrosInvalidos Int            @map("registros_invalidos")
  usuario            String?        @db.VarChar(100)
  createdAt          DateTime       @default(now()) @map("created_at")
  marcaciones        MarcacionRaw[]

  @@index([fechaInicio, fechaFin])
  @@map("importaciones")
}

model MarcacionRaw {
  id            Int                @id @default(autoincrement())
  numeroAC      String             @map("numero_ac") @db.VarChar(20)
  nombre        String             @db.VarChar(255)
  fechaHora     DateTime           @map("fecha_hora")
  estado        EstadoMarcacion
  excepcion     ExcepcionMarcacion @default(FOT)
  nuevoEstado   String?            @map("nuevo_estado") @db.VarChar(50)
  operacion     String?            @db.VarChar(50)
  importacionId Int                @map("importacion_id")
  createdAt     DateTime           @default(now()) @map("created_at")
  importacion   Importacion        @relation(fields: [importacionId], references: [id], onDelete: Cascade)

  @@index([numeroAC, fechaHora])
  @@index([importacionId])
  @@map("marcaciones_raw")
}

model AsistenciaDiaria {
  id              Int       @id @default(autoincrement())
  empleadoId      Int       @map("empleado_id")
  fecha           DateTime  @db.Date
  entrada1        DateTime? @map("entrada_1")
  salida1         DateTime? @map("salida_1")
  entrada2        DateTime? @map("entrada_2")
  salida2         DateTime? @map("salida_2")
  entrada3        DateTime? @map("entrada_3")
  salida3         DateTime? @map("salida_3")
  horasTrabajadas Decimal   @default(0) @map("horas_trabajadas") @db.Decimal(5, 2)
  tieneErrores    Boolean   @default(false) @map("tiene_errores")
  tipoError       String?   @map("tipo_error") @db.VarChar(100)
  observaciones   String?
  marcacionesRaw  String?   @map("marcaciones_raw")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  empleado        Empleado  @relation(fields: [empleadoId], references: [id], onDelete: Cascade)

  @@unique([empleadoId, fecha], name: "unique_empleado_fecha")
  @@index([fecha])
  @@index([empleadoId, fecha])
  @@map("asistencia_diaria")
}

model ResumenMensual {
  id             Int      @id @default(autoincrement())
  empleadoId     Int      @map("empleado_id")
  año           Int
  mes            Int
  diasTrabajados Int      @default(0) @map("dias_trabajados")
  totalHoras     Decimal  @default(0) @map("total_horas") @db.Decimal(7, 2)
  diasConErrores Int      @default(0) @map("dias_con_errores")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  empleado       Empleado @relation(fields: [empleadoId], references: [id], onDelete: Cascade)

  @@unique([empleadoId, año, mes], name: "unique_empleado_periodo")
  @@index([año, mes])
  @@map("resumen_mensual")
}

model Informe {
  id                  Int         @id @default(autoincrement())
  empleadoId          Int         @map("empleado_id")
  tipoInforme         TipoInforme @map("tipo_informe")
  fechaInicio         DateTime    @map("fecha_inicio") @db.Date
  fechaFin            DateTime    @map("fecha_fin") @db.Date
  archivoPath         String?     @map("archivo_path") @db.VarChar(500)
  totalDiasTrabajados Int?        @map("total_dias_trabajados")
  totalHoras          Decimal?    @map("total_horas") @db.Decimal(7, 2)
  createdAt           DateTime    @default(now()) @map("created_at")
  empleado            Empleado    @relation(fields: [empleadoId], references: [id], onDelete: Cascade)

  @@index([empleadoId, fechaInicio, fechaFin])
  @@map("informes")
}

enum Role {
  SUPERADMIN
  ADMIN
  USER
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  JUSTIFIED
}

enum TipoArchivo {
  marcaciones
  invalidos

  @@map("tipo_archivo")
}

enum EstadoMarcacion {
  Entrada
  Salida

  @@map("estado_marcacion")
}

enum ExcepcionMarcacion {
  FOT
  Invalido
  Repetido

  @@map("excepcion_marcacion")
}

enum TipoInforme {
  tolerante
  estricto

  @@map("tipo_informe")
}
